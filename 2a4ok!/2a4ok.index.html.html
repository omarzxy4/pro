<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>لعبة أشك</title>
  <style>
    body {
      background-color: #0b6623;
      font-family: 'Arial', sans-serif;
      color: white;
      margin: 0;
      padding: 0;
      text-align: center;
      overflow-x: hidden; 
    }
    .screen {
      display: none;
      padding: 10px;
      min-height: 95vh;
      box-sizing: border-box;
      position: relative; /* For positioning player areas relative to the screen */
    }
    .active {
      display: block;
    }
    .card {
      /* Base size for cards on table or revealed in cheat */
      width: 60px; 
      height: 90px;
      margin: 3px;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.2s, border-color 0.2s, background-image 0.3s ease-in-out, width 0.3s ease, height 0.3s ease;
      background-size: cover;
      display: inline-block; 
      background-repeat: no-repeat;
      background-position: center;
    }
    .card.face-down {
        background-image: url('cards/back.png');
    }
    .card:hover {
      transform: scale(1.05); 
    }
    .selected {
      border-color: yellow !important; 
      box-shadow: 0 0 10px yellow;
    }
    #table-cards {
      margin-top: 10px;
      margin-bottom: 15px;
      min-height: 100px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 5px;
    }
    #table-cards .card { 
      width: 60px;
      height: 96px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }
    #table-cards .card.reveal {
      animation: revealCard 0.5s ease forwards;
    }
    @keyframes revealCard {
      0% { transform: scale(0.5) rotateY(90deg); opacity: 0; }
      100% { transform: scale(1) rotateY(0); opacity: 1; }
    }
    .button {
      padding: 8px 15px; margin: 5px; font-size: 16px; cursor: pointer;
      border: none; border-radius: 8px; background-color: #ffcc00; color: black;
    }
    .current-claim {
      font-size: 18px; /* Slightly smaller */
      margin: 5px 0; /* Adjusted margin */
      padding: 6px;
      background-color: #1a472a; border-radius: 8px; display: inline-block;
    }
    .player-name-input {
        margin: 5px; padding: 8px; border-radius: 5px; border: 1px solid #ccc;
    }

    #game-board-container { 
        position: absolute; 
        top: 50%; 
        left: 50%; 
        transform: translate(-50%, -50%);
        width: 45%;
        max-width: 400px; 
        min-height: 300px; 
        border: 3px solid rgba(26, 71, 42, 0.8); 
        border-radius: 20px; 
        padding: 20px; 
        box-sizing: border-box;
        display: flex; 
        flex-direction: column;
        justify-content: space-between; 
        align-items: center;
        background-color: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }
    .player-area {
        position: absolute; 
        padding: 8px; 
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        background-color: rgba(0, 0, 0, 0.4); 
        min-width: 120px; 
        max-width: 250px;
        text-align: center; 
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
    }
    .player-area .player-info {
        font-size: 0.9em;
        margin-bottom: 5px; 
        padding: 3px 8px; 
        border: 2px solid transparent; 
        border-radius: 8px;
        display: inline-block;
        background-color: rgba(255, 255, 255, 0.1);
    }
    .player-area.current-player-area .player-info .player-name {
        background-color: rgba(255, 255, 255, 0.2); 
        padding: 1px 3px;
        border-radius: 3px;
        font-weight: bold;
    }
    .player-hand-display {
        display: flex; 
        justify-content: center; 
        flex-wrap: wrap;
        min-height: 70px;
        align-items: center;
        position: relative;
        max-height: 250px; /* Set maximum height for scrolling */
        overflow-y: auto; /* Enable vertical scrolling */
        overflow-x: hidden; /* Hide horizontal scrollbar */
        padding: 10px;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
    }
    /* Webkit scrollbar styling */
    .player-hand-display::-webkit-scrollbar {
        width: 8px;
    }

    .player-hand-display::-webkit-scrollbar-track {
        background: transparent;
    }

    .player-hand-display::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
    }

    .player-hand-display::-webkit-scrollbar-thumb:hover {
        background-color: rgba(255, 255, 255, 0.5);
    }

    /* Default bigger size for cards in player hands */
    .player-hand-display .card {
        width: 60px; 
        height: 96px;
        margin: 2px;
        border-width: 2px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }
    /* Enlarged size for current player's revealed cards */
    .player-hand-display .card.enlarged-card {
        width: 80px;
        height: 120px;
        margin: 5px;
        border-width: 2px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        flex-shrink: 0; /* Prevent cards from shrinking */
    }
    .player-hand-display .cards-count {
        position: absolute;
        bottom: -20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.9em;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .player-area.current-player-area {
        border-color: yellow; 
        z-index: 10;
    }

    /* Updated player positions for better layout */
    .player-pos-0 { bottom: 20px; left: 50%; transform: translateX(-50%); } 
    .player-pos-1 { top: 20px; left: 50%; transform: translateX(-50%); }    
    .player-pos-2 { top: 50%; left: 20px; transform: translateY(-50%); }    
    .player-pos-3 { top: 50%; right: 20px; transform: translateY(-50%); }   
    .player-pos-4 { top: 20px; left: 20px; }                                 
    .player-pos-5 { top: 20px; right: 20px; }

    /* Add hover effect for cards */
    .player-hand-display .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
    }

    #game-controls {
        position: relative;
        width: 100%;
        max-width: 600px;
        padding: 10px;
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 12px;
        margin-top: 10px;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    #game-controls input[type="text"] {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-right: 5px;
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        width: 80px;
    }
    #game-controls input[type="text"]::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }
    #game-controls .button {
        padding: 8px 15px;
        margin: 5px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        background-color: #ffcc00;
        color: black;
        transition: all 0.3s ease;
    }
    #game-controls .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .card.face-down.clickable {
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    .card.face-down.clickable:hover {
        transform: scale(1.05);
    }
    .card.face-down.clickable::after {
        content: 'انقر لإظهار الأوراق';
        position: absolute;
        bottom: -20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.8em;
        color: white;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 2px 8px;
        border-radius: 10px;
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    .card.face-down.clickable:hover::after {
        opacity: 1;
    }
    .hide-cards-button {
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #ff4444;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 15px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
        z-index: 10;
    }
    .hide-cards-button:hover {
        background-color: #cc0000;
        transform: translateX(-50%) scale(1.05);
    }

    /* Add scroll indicator when cards are revealed */
    .scroll-indicator {
        position: absolute;
        bottom: 5px;
        left: 50%;
        transform: translateX(-50%);
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.8em;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 2px 8px;
        border-radius: 10px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .player-hand-display:hover .scroll-indicator {
        opacity: 1;
    }

    .doubt-button {
        margin-top: 5px;
        padding: 4px 12px;
        background-color: #ff4444;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
        opacity: 1;
    }

    .doubt-button:hover {
        opacity: 0.9;
        transform: scale(1.05);
        background-color: #ff2222;
    }

    .doubt-button:disabled {
        background-color: #666;
        cursor: not-allowed;
        opacity: 0.5;
        transform: none;
    }
  </style>
</head>
<body>
  <div class="screen active" id="mode-selection-screen">
    <h1>اختر نمط اللعب</h1>
    <button class="button" id="local-mode-btn">لعب محلي (Local)</button>
    <button class="button" id="online-mode-btn">لعب عبر الإنترنت (Online)</button>
  </div>

  <div class="screen" id="online-mode-screen">
    <button class="button" id="back-to-mode-select-btn" style="position: absolute; top: 20px; left: 20px;">رجوع</button>
    <h1 style="text-align: center; margin-top: 40vh; font-size: 2em;">Coming Soon</h1>
  </div>

  <div class="screen" id="player-setup-screen">
    <h1>اختيار عدد اللاعبين وأسمائهم</h1>
    <label for="player-count">عدد اللاعبين (2-6):</label>
    <input type="number" id="player-count" min="2" max="6" value="2" style="margin-bottom: 15px;">
    <br>
    <div id="player-names-container"></div>
    <button class="button" id="proceed-to-game-btn">التالي</button>
  </div>

  <div class="screen" id="game-screen"> 
    <!-- Player areas will be appended here by JS, positioned absolutely to game-screen -->
    
    <div id="game-board-container"> <!-- This is now just the central table -->
        <div class="current-claim" id="current-claim-display">الرقم الحالي: -</div>
        <div id="table-cards"></div>
    </div>

    <div id="game-controls">
        <input type="text" id="claim-value" placeholder="مثلاً: 4" disabled maxlength="2">
        <button class="button" id="submit-claim-btn">تم</button>
        <button class="button" id="pass-button">Pass</button>
    </div>
  </div>

  <script>
    const ALL_CARD_NAMES = [
      "2_of_clubs", "2_of_diamonds", "2_of_hearts", "2_of_spades", "3_of_clubs", "3_of_diamonds", "3_of_hearts", "3_of_spades",
      "4_of_clubs", "4_of_diamonds", "4_of_hearts", "4_of_spades", "5_of_clubs", "5_of_diamonds", "5_of_hearts", "5_of_spades",
      "6_of_clubs", "6_of_diamonds", "6_of_hearts", "6_of_spades", "7_of_clubs", "7_of_diamonds", "7_of_hearts", "7_of_spades",
      "8_of_clubs", "8_of_diamonds", "8_of_hearts", "8_of_spades", "9_of_clubs", "9_of_diamonds", "9_of_hearts", "9_of_spades",
      "10_of_clubs", "10_of_diamonds", "10_of_hearts", "10_of_spades", "jack_of_clubs", "jack_of_diamonds", "jack_of_hearts", "jack_of_spades",
      "queen_of_clubs", "queen_of_diamonds", "queen_of_hearts", "queen_of_spades", "king_of_clubs", "king_of_diamonds", "king_of_hearts", "king_of_spades",
      "ace_of_clubs", "ace_of_diamonds", "ace_of_hearts", "ace_of_spades"
    ];

    let players = []; 
    let currentPlayerIndex = 0;
    let tableCards = [];
    let lastPlayedCards = [];
    let currentClaim = ""; 
    let passCount = 0;
    let gameStarted = false;
    let roundStarterIndex = 0;
    let indexOfLastPlayerWhoPlayed = 0;
    let cardsRevealedForCurrentPlayer = false;
    let winners = [];

    let localModeBtn, onlineModeBtn, backToModeSelectBtn, playerCountInput, 
        playerNamesContainer, proceedToGameBtn, claimValueInput, submitClaimBtn, 
        passButton, currentClaimDisplay, 
        tableCardsDiv, gameBoardContainer, gameScreenDiv;

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function shuffle(array) { 
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
    function normalizeClaimForComparison(claim) { 
      if (!claim) return ""; const lowerClaim = claim.toLowerCase().trim();
      switch (lowerClaim) { case "j": return "jack"; case "q": return "queen"; case "k": return "king"; case "a": return "ace"; default: return lowerClaim; }
    }

    function generatePlayerNameInputs() {
      const count = parseInt(playerCountInput.value);
      playerNamesContainer.innerHTML = ''; 
      if (count >= 2 && count <= 6) {
        for (let i = 0; i < count; i++) {
          const input = document.createElement('input');
          input.type = 'text'; input.placeholder = `اسم اللاعب ${i + 1}`; input.id = `player-name-${i}`;
          input.className = 'player-name-input'; playerNamesContainer.appendChild(input);
          playerNamesContainer.appendChild(document.createElement('br'));
        }
      }
    }
    
    function proceedToGameSetup() { startGame(); }

    function startGame() {
      const count = parseInt(playerCountInput.value);
      const playerNames = [];
      for (let i = 0; i < count; i++) {
        const nameInput = document.getElementById(`player-name-${i}`);
        playerNames.push((nameInput ? nameInput.value.trim() : '') || `اللاعب ${i + 1}`);
      }
      players = Array.from({ length: count }, (_, i) => ({ name: playerNames[i], hand: [], id: `player-area-${i}` }));
      const shuffledCards = shuffle([...ALL_CARD_NAMES]);
      const totalCardsToDeal = Math.floor(shuffledCards.length / count) * count;
      for (let i = 0; i < totalCardsToDeal; i++) { players[i % count].hand.push(shuffledCards[i]); }
      
      showScreen('game-screen');
      gameStarted = true;
      roundStarterIndex = 0;
      indexOfLastPlayerWhoPlayed = 0;
      currentPlayerIndex = roundStarterIndex;
      currentClaim = "";
      tableCards = [];
      lastPlayedCards = [];
      passCount = 0;
      cardsRevealedForCurrentPlayer = false;
      winners = []; // Reset winners array
      renderGameBoard();
      nextTurn();
    }
    
    function getPlayerPositionClass(index, totalPlayers) {
        const positions = ['player-pos-0', 'player-pos-1', 'player-pos-2', 'player-pos-3', 'player-pos-4', 'player-pos-5'];
        if (totalPlayers === 2) return index === 0 ? 'player-pos-0' : 'player-pos-1';
        if (totalPlayers === 3) { const map = ['player-pos-0', 'player-pos-4', 'player-pos-5']; return map[index]; }
        if (totalPlayers === 4) { const map = ['player-pos-0', 'player-pos-2', 'player-pos-1', 'player-pos-3']; return map[index]; }
        if (totalPlayers === 5) { const map = ['player-pos-0', 'player-pos-2', 'player-pos-4', 'player-pos-5', 'player-pos-3']; return map[index]; }
        if (totalPlayers === 6) { const map = ['player-pos-0', 'player-pos-2', 'player-pos-4', 'player-pos-1', 'player-pos-5', 'player-pos-3']; return map[index]; }
        return positions[index % positions.length]; 
    }

    function renderGameBoard() {
        if (!gameScreenDiv) return;
        gameScreenDiv.querySelectorAll('.player-area').forEach(pa => pa.remove()); 
        players.forEach((player, index) => {
            const playerArea = document.createElement('div');
            playerArea.className = `player-area ${getPlayerPositionClass(index, players.length)}`;
            playerArea.id = player.id;
            
            const playerInfo = document.createElement('div');
            playerInfo.className = 'player-info';
            playerInfo.innerHTML = `<span class="player-name">${player.name}</span> (<span class="card-count">${player.hand.length}</span> كارت)`;
            
            const handDisplay = document.createElement('div');
            handDisplay.className = 'player-hand-display';
            
            // Add doubt button with player name
            const doubtButton = document.createElement('button');
            doubtButton.className = 'doubt-button';
            doubtButton.textContent = `شك (${player.name})`;
            doubtButton.onclick = () => callCheat(index);
            
            // Disable doubt buttons at the start of a round (when currentClaim is empty)
            // or if this is the player who played the last cards
            doubtButton.disabled = currentClaim === "" || index === indexOfLastPlayerWhoPlayed;
            
            playerArea.appendChild(playerInfo);
            playerArea.appendChild(handDisplay);
            playerArea.appendChild(doubtButton);
            gameScreenDiv.appendChild(playerArea); 
        });
        updatePlayerHandsDisplay(cardsRevealedForCurrentPlayer); 
    }

    // Add card sorting function
    function getCardValue(cardName) {
        const value = cardName.split('_of_')[0];
        const valueMap = {
            'ace': 1,
            'jack': 11,
            'queen': 12,
            'king': 13
        };
        return valueMap[value] || parseInt(value);
    }

    function getSuitOrder(cardName) {
        const suit = cardName.split('_of_')[1];
        const suitOrder = { 'clubs': 0, 'diamonds': 1, 'hearts': 2, 'spades': 3 };
        return suitOrder[suit];
    }

    function compareCards(cardA, cardB) {
        const valueA = getCardValue(cardA);
        const valueB = getCardValue(cardB);
        
        if (valueA === valueB) {
            // If values are equal, sort by suit
            return getSuitOrder(cardA) - getSuitOrder(cardB);
        }
        return valueA - valueB;
    }

    // Modify the updatePlayerHandsDisplay function to sort cards
    function updatePlayerHandsDisplay(revealCards) {
        players.forEach((player, index) => {
            const playerAreaNode = document.getElementById(player.id);
            if (!playerAreaNode) return;
            const handDisplayNode = playerAreaNode.querySelector('.player-hand-display');
            const cardCountNode = playerAreaNode.querySelector('.card-count');
            if (!handDisplayNode || !cardCountNode) return;

            // Remove any existing hide button
            const existingHideButton = playerAreaNode.querySelector('.hide-cards-button');
            if (existingHideButton) {
                existingHideButton.remove();
            }

            handDisplayNode.innerHTML = '';
            cardCountNode.textContent = player.hand.length;
            playerAreaNode.classList.toggle('current-player-area', index === currentPlayerIndex);

            // Add warning for 4 or fewer cards
            if (player.hand.length <= 4 && index === currentPlayerIndex) {
                const warningText = document.createElement('div');
                warningText.style.cssText = `
                    position: absolute;
                    top: -20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background-color: rgba(255, 165, 0, 0.9);
                    color: white;
                    padding: 2px 8px;
                    border-radius: 10px;
                    font-size: 0.8em;
                    white-space: nowrap;
                `;
                warningText.textContent = 'يمكنك لعب كارت واحد فقط';
                playerAreaNode.appendChild(warningText);
            }

            if (index === currentPlayerIndex) {
                if (revealCards) {
                    // Add hide button when cards are revealed
                    const hideButton = document.createElement('button');
                    hideButton.className = 'hide-cards-button';
                    hideButton.textContent = 'إخفاء الأوراق';
                    hideButton.onclick = () => {
                        cardsRevealedForCurrentPlayer = false;
                        updatePlayerHandsDisplay(false);
                    };
                    playerAreaNode.appendChild(hideButton);

                    // Create a container for the scroll indicator
                    const scrollIndicator = document.createElement('div');
                    scrollIndicator.className = 'scroll-indicator';
                    scrollIndicator.textContent = 'مرر لرؤية المزيد';
                    handDisplayNode.appendChild(scrollIndicator);

                    // Sort the cards before displaying them
                    const sortedCards = [...player.hand].sort(compareCards);

                    // Show the sorted cards
                    sortedCards.forEach(cardName => {
                        const cardDiv = document.createElement('div');
                        cardDiv.className = 'card enlarged-card';
                        cardDiv.dataset.cardName = cardName;
                        cardDiv.style.backgroundImage = `url('cards/${cardName}.png')`;
                        cardDiv.onclick = () => {
                            if (player.hand.length <= 4 && handDisplayNode.querySelectorAll('.selected.enlarged-card').length > 0 && !cardDiv.classList.contains('selected')) {
                                return alert("عندما يكون لديك 4 كروت أو أقل، يمكنك لعب كارت واحد فقط!");
                            }
                            cardDiv.classList.toggle('selected');
                            const selectedCount = handDisplayNode.querySelectorAll('.selected.enlarged-card').length;
                            if (selectedCount > 4) {
                                cardDiv.classList.remove('selected');
                                alert("لا يمكنك اختيار أكثر من 4 أوراق!");
                            }
                        };
                        handDisplayNode.appendChild(cardDiv);
                    });

                    // Check if scrolling is needed and show/hide indicator accordingly
                    setTimeout(() => {
                        if (handDisplayNode.scrollHeight > handDisplayNode.clientHeight) {
                            scrollIndicator.style.opacity = '1';
                        }
                    }, 100);
                } else {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card face-down clickable';
                    cardDiv.onclick = () => {
                        cardsRevealedForCurrentPlayer = !cardsRevealedForCurrentPlayer;
                        updatePlayerHandsDisplay(cardsRevealedForCurrentPlayer);
                    };
                    handDisplayNode.appendChild(cardDiv);
                    
                    const countDiv = document.createElement('div');
                    countDiv.className = 'cards-count';
                    countDiv.textContent = `${player.hand.length} كارت`;
                    handDisplayNode.appendChild(countDiv);
                }
            } else {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card face-down';
                handDisplayNode.appendChild(cardDiv);
                
                const countDiv = document.createElement('div');
                countDiv.className = 'cards-count';
                countDiv.textContent = `${player.hand.length} كارت`;
                handDisplayNode.appendChild(countDiv);
            }
        });
    }

    function resetGame() {
        showScreen('mode-selection-screen');
        if(playerNamesContainer) playerNamesContainer.innerHTML = '';
        playerCountInput.value = "2";
        players = [];
        currentPlayerIndex = 0;
        tableCards = [];
        lastPlayedCards = [];
        currentClaim = "";
        passCount = 0;
        gameStarted = false;
        roundStarterIndex = 0;
        indexOfLastPlayerWhoPlayed = 0;
        cardsRevealedForCurrentPlayer = false;
        winners = []; // Reset winners array
        if(currentClaimDisplay) currentClaimDisplay.innerText = `الرقم الحالي: -`;
        if(tableCardsDiv) tableCardsDiv.innerHTML = "";
        if(claimValueInput) claimValueInput.value = "";
        if(gameScreenDiv) gameScreenDiv.querySelectorAll('.player-area').forEach(pa => pa.remove());
    }

    function nextTurn() {
        if (!gameStarted || players.length === 0) return;
        cardsRevealedForCurrentPlayer = false;
        
        // Check for winners
        for (let i = 0; i < players.length; i++) {
            if (players[i].hand.length === 0) {
                alert(`${players[i].name} فاز بالمركز ${winners.length + 1}!`);
                if (handlePlayerWin(players[i])) return;
                renderGameBoard();
                break;
            }
        }
        
        currentClaimDisplay.innerText = `الرقم الحالي: ${currentClaim || "-"}`;
        claimValueInput.disabled = !(currentPlayerIndex === roundStarterIndex && currentClaim === "");
        claimValueInput.placeholder = claimValueInput.disabled ? (currentClaim ? `يلعب على الرقم: ${currentClaim}` : "انتظر اختيار الرقم") : "اختر رقم للجولة";
        passButton.style.display = (currentPlayerIndex === roundStarterIndex && currentClaim === "") ? 'none' : 'inline-block';
        updatePlayerHandsDisplay(false);
    }
    
    function submitClaim() {
        if (!gameStarted) return;
        const currentPlayerArea = document.getElementById(players[currentPlayerIndex].id);
        if (!currentPlayerArea) return;
        const handDisplayNode = currentPlayerArea.querySelector('.player-hand-display');
        const selectedCardsDivs = handDisplayNode.querySelectorAll(".card.selected.enlarged-card");
        
        if (!cardsRevealedForCurrentPlayer && selectedCardsDivs.length > 0) { 
            return alert("خلل: تم اختيار أوراق بدون إظهارها!");
        }
        if (cardsRevealedForCurrentPlayer && selectedCardsDivs.length === 0 && !(currentPlayerIndex === roundStarterIndex && currentClaim === "")) {
            return alert("اختر أوراقًا للعب أو أخفِ أوراقك لتمرير الدور أو الشك.");
        }

        // Check if player has 4 or fewer cards and trying to play more than 1
        if (players[currentPlayerIndex].hand.length <= 4 && selectedCardsDivs.length > 1) {
            return alert("عندما يكون لديك 4 كروت أو أقل، يمكنك لعب كارت واحد فقط!");
        }

        const claimText = claimValueInput.value;
        if (currentPlayerIndex === roundStarterIndex && currentClaim === "") {
            const validRanks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'j', 'q', 'k', 'a'];
            const normalizedClaimText = claimText.toLowerCase().trim();
            if (!claimText || !validRanks.includes(normalizedClaimText)) {
                claimValueInput.value = "";
                return alert("الرجاء إدخال قيمة كارت صحيحة (2-10, J, Q, K, A).");
            }
            if (selectedCardsDivs.length === 0 && cardsRevealedForCurrentPlayer) return alert("اختر أوراقًا للعب مع تحديد الرقم!");
            if (selectedCardsDivs.length === 0 && !cardsRevealedForCurrentPlayer) return alert("يجب إظهار واختيار أوراق للعب مع تحديد الرقم!");
            if (selectedCardsDivs.length > 4) return alert("لا يمكنك لعب أكثر من 4 أوراق!");
            currentClaim = claimText;
            // Re-render the game board to enable doubt buttons after a claim is made
            renderGameBoard();
        } else {
            if (!currentClaim) return alert("يجب أن يتم تحديد رقم للجولة أولاً!");
            if (selectedCardsDivs.length === 0) return alert("اختر أوراقًا للعب!");
            if (selectedCardsDivs.length > 4) return alert("لا يمكنك لعب أكثر من 4 أوراق!");
        }

        let playedCardNames = [];
        selectedCardsDivs.forEach(cardDiv => { playedCardNames.push(cardDiv.dataset.cardName); });
        
        cardsRevealedForCurrentPlayer = false; 
        updatePlayerHandsDisplay(false); 

        setTimeout(() => {
            playedCardNames.forEach(cardName => {
                players[currentPlayerIndex].hand = players[currentPlayerIndex].hand.filter(c => c !== cardName);
            });
            lastPlayedCards = playedCardNames;
            tableCards.push(...playedCardNames);
            indexOfLastPlayerWhoPlayed = currentPlayerIndex;
            passCount = 0;
            updateTableDisplay();
            claimValueInput.value = "";
            currentPlayerIndex = (currentPlayerIndex - 1 + players.length) % players.length;
            if (currentPlayerIndex < 0) currentPlayerIndex = players.length - 1;
            nextTurn();
            // Re-render the game board to update doubt button states
            renderGameBoard();
        }, 200);
    }

    function passTurn() { 
        if (!gameStarted) return; 
        passCount++; 
        cardsRevealedForCurrentPlayer = false;
        
        if (passCount >= players.length - 1 && players.length > 1) {
            alert(`جميع اللاعبين قالوا Pass! ${players[indexOfLastPlayerWhoPlayed].name} يبدأ جولة جديدة لأنه آخر من لعب الورق.`);
            roundStarterIndex = indexOfLastPlayerWhoPlayed; 
            currentPlayerIndex = roundStarterIndex;
            currentClaim = ""; 
            passCount = 0;
            // Keep the cards on the table, don't clear them
            // tableCards = []; 
            // lastPlayedCards = [];
            // updateTableDisplay(); 
            nextTurn(); 
            return;
        }
        currentPlayerIndex = (currentPlayerIndex - 1 + players.length) % players.length;
        if (currentPlayerIndex < 0) currentPlayerIndex = players.length - 1;
        nextTurn();
    }

    function updateTableDisplay() { 
        tableCardsDiv.innerHTML = "";
        tableCards.forEach(() => { const img = document.createElement("div"); img.className = "card face-down"; tableCardsDiv.appendChild(img); });
    }

    function callCheat(challengerIndex = currentPlayerIndex) { 
        if (challengerIndex === indexOfLastPlayerWhoPlayed) {
            alert("لا يمكنك الشك في نفسك!");
            return;
        }
        
        if (!lastPlayedCards.length) {
            alert("لا يوجد أوراق على الطاولة للشك فيها!");
            return;
        }

        if (currentClaim === "") {
            alert("انتظر حتى يتم تحديد الرقم للجولة!");
            return;
        }
        
        cardsRevealedForCurrentPlayer = false; 
        const normalizedClaimedRank = normalizeClaimForComparison(currentClaim); 
        let isLiar;
        
        if (lastPlayedCards.length >= 2) { 
            isLiar = false; 
            for (const cardName of lastPlayedCards) { 
                if (cardName.split('_of_')[0] !== normalizedClaimedRank) { 
                    isLiar = true; 
                    break; 
                } 
            }
        } else { 
            isLiar = (lastPlayedCards[0].split('_of_')[0] !== normalizedClaimedRank); 
        }
        
        const challengedPlayer = players[indexOfLastPlayerWhoPlayed];
        const challengerPlayer = players[challengerIndex];
        
        tableCardsDiv.innerHTML = ""; 
        lastPlayedCards.forEach(cardName => { 
            const cardDiv = document.createElement("div"); 
            cardDiv.className = "card reveal"; 
            cardDiv.style.backgroundImage = `url('cards/${cardName}.png')`; 
            tableCardsDiv.appendChild(cardDiv); 
        });
        
        setTimeout(() => {
            if (isLiar) { 
                challengedPlayer.hand.push(...tableCards); 
                alert(`الشك صحيح! ${challengedPlayer.name} يأخذ كل الأوراق لأنه خدع. ${challengerPlayer.name} يبدأ الجولة الجديدة لأنه كشف الخداع.`); 
                roundStarterIndex = challengerIndex;
            } else { 
                challengerPlayer.hand.push(...tableCards); 
                alert(`الشك خاطئ! ${challengerPlayer.name} (الذي شك) يأخذ كل الأوراق لأنه اتهم زوراً. ${challengedPlayer.name} يبدأ الجولة الجديدة لأنه كان صادقاً.`); 
                roundStarterIndex = indexOfLastPlayerWhoPlayed; 
            }
            currentPlayerIndex = roundStarterIndex; 
            currentClaim = ""; 
            // Only clear the cards when someone takes them through doubt
            tableCards = []; 
            lastPlayedCards = []; 
            passCount = 0;
            updateTableDisplay(); 
            nextTurn();
            // Re-render the game board to update doubt button states
            renderGameBoard();
        }, 2500);
    }

    function handlePlayerWin(winningPlayer) {
        winners.push(winningPlayer.name);
        
        // Remove winning player from the game
        const winningPlayerIndex = players.findIndex(p => p.id === winningPlayer.id);
        if (winningPlayerIndex !== -1) {
            players.splice(winningPlayerIndex, 1);
        }

        // If only one player remains, they're the last place
        if (players.length === 1) {
            winners.push(players[0].name);
            
            // Create a stylish winners announcement
            const winnersAnnouncement = document.createElement('div');
            winnersAnnouncement.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: rgba(0, 0, 0, 0.9);
                padding: 30px;
                border-radius: 20px;
                border: 3px solid gold;
                color: white;
                text-align: center;
                min-width: 300px;
                z-index: 1000;
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
                backdrop-filter: blur(10px);
            `;
            
            const winnersList = winners.map((name, index) => `
                <div style="
                    margin: 10px 0;
                    padding: 10px;
                    background-color: rgba(255, 255, 255, 0.1);
                    border-radius: 10px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <span style="color: gold; font-weight: bold; margin-right: 10px;">#${index + 1}</span>
                    <span>${name}</span>
                </div>
            `).join('');
            
            winnersAnnouncement.innerHTML = `
                <h2 style="color: gold; margin-top: 0;">انتهت اللعبة!</h2>
                <h3 style="color: #fff;">ترتيب الفائزين</h3>
                ${winnersList}
                <button onclick="this.parentElement.remove(); resetGame();" style="
                    margin-top: 20px;
                    padding: 10px 20px;
                    background-color: gold;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: bold;
                    transition: all 0.3s ease;
                ">حسناً</button>
            `;
            
            document.body.appendChild(winnersAnnouncement);
            return true;
        }

        // Adjust current player index if needed
        if (currentPlayerIndex >= players.length) {
            currentPlayerIndex = 0;
        }
        
        // Reset the round if the winning player was the last to play
        if (winningPlayerIndex === indexOfLastPlayerWhoPlayed) {
            currentClaim = "";
            tableCards = [];
            lastPlayedCards = [];
            passCount = 0;
            roundStarterIndex = currentPlayerIndex;
        }

        return false;
    }

    document.addEventListener('DOMContentLoaded', function() {
      localModeBtn = document.getElementById('local-mode-btn'); 
      onlineModeBtn = document.getElementById('online-mode-btn');
      backToModeSelectBtn = document.getElementById('back-to-mode-select-btn'); 
      playerCountInput = document.getElementById('player-count');
      playerNamesContainer = document.getElementById('player-names-container'); 
      proceedToGameBtn = document.getElementById('proceed-to-game-btn');
      claimValueInput = document.getElementById('claim-value'); 
      submitClaimBtn = document.getElementById('submit-claim-btn');
      passButton = document.getElementById('pass-button');
      currentClaimDisplay = document.getElementById('current-claim-display');
      tableCardsDiv = document.getElementById('table-cards'); 
      gameBoardContainer = document.getElementById('game-board-container');
      gameScreenDiv = document.getElementById('game-screen');

      localModeBtn.addEventListener('click', () => { showScreen('player-setup-screen'); generatePlayerNameInputs(); });
      onlineModeBtn.addEventListener('click', () => showScreen('online-mode-screen'));
      backToModeSelectBtn.addEventListener('click', () => showScreen('mode-selection-screen'));
      playerCountInput.addEventListener('input', () => {
        let value = parseInt(playerCountInput.value); 
        if (isNaN(value)) playerCountInput.value = '2';
        else if (value < 2) playerCountInput.value = '2'; 
        else if (value > 6) playerCountInput.value = '6';
        generatePlayerNameInputs();
      });
      proceedToGameBtn.addEventListener('click', proceedToGameSetup);
      claimValueInput.addEventListener('input', function() { 
        if (this.disabled) return; 
        let currentVal = this.value; 
        let finalVal = "";
        const singleValidChars = /^[ajqk2-9]$/i; 
        const firstCharForTen = "1";
        if (currentVal.length > 0) { 
            let first = currentVal[0].toLowerCase();
            if (first === firstCharForTen) { 
                finalVal = "1"; 
                if (currentVal.length > 1 && currentVal[1] === "0") finalVal = "10"; 
            } 
            else if (singleValidChars.test(first)) { finalVal = first; }
        } 
        this.value = (finalVal.length === 1 && /^[ajqk]$/i.test(finalVal)) ? finalVal.toUpperCase() : finalVal;
      });
      submitClaimBtn.addEventListener('click', submitClaim);
      passButton.addEventListener('click', passTurn);
      showScreen('mode-selection-screen'); 
      generatePlayerNameInputs(); 
    });
  </script>
</body>
</html>